<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Claude Remote</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #2d2d2d;
      --surface: #333333;
      --text: #f0f0f0;
      --text-dim: #999;
      --accent: #3ecf8e;
      --accent-hover: #4ee0a0;
      --green: #3ecf8e;
      --yellow: #f5c542;
      --red: #ef5350;
      --radius: 12px;
      --shadow-dark: #252525;
      --shadow-light: #3a3a3a;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #e0e0e0;
        --surface: #e8e8e8;
        --text: #1a1a1a;
        --text-dim: #666;
        --accent: #2ea86e;
        --accent-hover: #3ecf8e;
        --green: #2ea86e;
        --yellow: #d4a830;
        --red: #d43f3f;
        --shadow-dark: #c8c8c8;
        --shadow-light: #f5f5f5;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Neumorphic base */
    .neu {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow:
        4px 4px 8px var(--shadow-dark),
        -4px -4px 8px var(--shadow-light);
    }
    .neu-inset {
      background: var(--bg);
      border-radius: 8px;
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }

    /* Header */
    .header {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      background: var(--bg);
    }
    .header h1 { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; }
    .header a { color: inherit; text-decoration: none; }
    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      background: var(--bg);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .status-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--red);
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 8px rgba(62,207,142,0.5); }
    .status-dot.busy { background: var(--yellow); box-shadow: 0 0 8px rgba(245,197,66,0.4); }
    .status-dot.offline { background: var(--red); }
    .daemon-info {
      font-size: 10px;
      color: var(--text-dim);
      margin-left: 4px;
    }

    /* Buttons */
    .btn {
      padding: 5px 14px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
      background: var(--surface);
      color: var(--text-dim);
      box-shadow:
        3px 3px 6px var(--shadow-dark),
        -3px -3px 6px var(--shadow-light);
    }
    .btn:hover {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .btn:active {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .btn-accent { color: var(--accent); }
    .btn-accent:hover { color: var(--accent-hover); }

    /* Hamburger menu (mobile) */
    .hamburger {
      display: none;
      background: var(--surface);
      border: none;
      color: var(--text);
      font-size: 18px;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-right: 6px;
      margin-top: -2px;
      box-shadow:
        3px 3px 6px var(--shadow-dark),
        -3px -3px 6px var(--shadow-light);
    }
    .hamburger:active {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .header-actions-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z: 9;
    }
    .header-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    @media (max-width: 600px) {
      .hamburger { display: flex; }
      .header-actions {
        display: none;
        position: absolute;
        top: 100%;
        right: 12px;
        flex-direction: column;
        align-items: stretch;
        background: var(--surface);
        border-radius: var(--radius);
        padding: 16px;
        gap: 12px;
        z-index: 10;
        box-shadow:
          4px 4px 8px var(--shadow-dark),
          -4px -4px 8px var(--shadow-light);
      }
      .header-actions.open { display: flex; }
      .header-actions-overlay.open { display: block; z-index: 9; }
      .header-actions .btn,
      .header-actions select { width: 100%; text-align: center; font-size: 16px !important; padding: 10px 20px !important; }
      .header-actions .lang-switcher,
      .header-actions .tts-switcher { width: 100%; }
      .header-actions .lang-switcher .btn,
      .header-actions .tts-switcher .btn { width: 100%; }
      .header-actions .lang-dropdown { position: static; width: 100%; margin-top: 6px; }
      .header { position: relative; }
      .tts-btn { width: 48px; height: 48px; font-size: 24px; }
    }

    /* Lang dropdown */
    .lang-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      background: var(--surface);
      border-radius: 10px;
      padding: 6px;
      min-width: 110px;
      box-shadow:
        4px 4px 8px var(--shadow-dark),
        -4px -4px 8px var(--shadow-light);
      z-index: 200;
    }
    .lang-dropdown.open { display: block; }
    .lang-dropdown a {
      display: block;
      padding: 7px 14px;
      border-radius: 6px;
      color: var(--text-dim);
      font-size: 13px;
      text-decoration: none;
      transition: all 0.15s;
      cursor: pointer;
    }
    .lang-dropdown a:hover {
      background: var(--bg);
      color: var(--text);
    }
    .lang-dropdown a.active {
      color: var(--accent);
      font-weight: 600;
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      -webkit-overflow-scrolling: touch;
    }
    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--text-dim); opacity: 0.3; border-radius: 2px; }

    .message {
      max-width: 85%;
      padding: 10px 14px;
      margin-bottom: 6px;
      border-radius: var(--radius);
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .message.user {
      margin-left: auto;
      background: transparent;
      text-align: right;
      border-bottom-right-radius: 4px;
    }
    .message.assistant {
      max-width: 100%;
      margin-right: 0;
      position: relative;
      padding: 8px 10px;
      background: var(--bg);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
      border-bottom-left-radius: 4px;
      display: flex;
      align-items: flex-start;
      white-space: normal;
    }
    .message.assistant > div {
      min-width: 0;
      flex: 1;
    }
    .message.assistant > div > p:first-child { margin-top: 0; }
    .message.assistant > div > p:last-child { margin-bottom: 0; }
    .message.processing::after {
      content: ' ‚è≥';
    }
    .message.error {
      color: var(--red);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light),
        0 0 0 1px var(--red);
    }
    .message.encrypted-blur {
      filter: blur(5px);
      user-select: none;
      opacity: 0.9;
      cursor: default;
      position: relative;
    }

    .message p { margin: 0 0 4px 0; }
    .message p:last-child { margin-bottom: 0; }
    .message ul, .message ol { margin: 4px 0; padding-left: 20px; }
    .message li { margin: 2px 0; }
    .message h1, .message h2, .message h3 { margin: 8px 0 4px 0; font-size: 1em; }
    .message h1 { font-size: 1.2em; }
    .message h2 { font-size: 1.1em; }
    .message blockquote {
      border-left: 3px solid var(--accent);
      margin: 6px 0;
      padding: 2px 10px;
      color: var(--text-dim);
    }
    .message table { border-collapse: collapse; margin: 6px 0; font-size: 13px; }
    .message th, .message td { border: 1px solid var(--shadow-dark); padding: 4px 8px; }
    .message th { background: rgba(255,255,255,0.03); }

    .message pre {
      background: var(--shadow-dark);
      padding: 8px 10px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 6px 0;
      font-size: 13px;
    }
    .message code {
      font-family: 'SF Mono', Menlo, monospace;
      font-size: 13px;
    }
    .message p code, .message li code {
      background: rgba(255,255,255,0.08);
      padding: 1px 5px;
      border-radius: 4px;
    }
    .message a { color: var(--accent); }

    /* TTS buttons */
    .tts-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      padding: 0;
      line-height: 1;
      margin-right: 8px;
      margin-top: 1px;
      flex-shrink: 0;
    }
    .tts-btn:active {
      opacity: 0.6;
    }
    .tts-btn.speaking { color: var(--accent); }
    .tts-btn.loading { opacity: 0.5; pointer-events: none; }
    .tts-provider-picker {
      display: none;
      position: absolute;
      bottom: 4px;
      left: 8px;
      display: flex;
      gap: 2px;
      z-index: 1;
    }
    .tts-provider-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--surface);
      border: none;
      color: var(--text-dim);
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      padding: 0;
      line-height: 1;
      box-shadow:
        2px 2px 4px var(--shadow-dark),
        -2px -2px 4px var(--shadow-light);
    }
    .tts-provider-btn.active {
      color: var(--accent);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }

    /* Input area */
    .input-area {
      padding: 10px 12px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: var(--bg);
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-shrink: 0;
    }
    .input-area textarea {
      flex: 1;
      color: var(--text);
      border: none;
      border-radius: 16px;
      padding: 10px 16px;
      font-size: 15px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      line-height: 1.4;
      outline: none;
      background: var(--bg);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .input-area textarea:focus {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light),
        0 0 0 2px rgba(62,207,142,0.3);
    }
    .send-btn {
      width: 40px;
      height: 40px;
      background: var(--surface);
      color: var(--accent);
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow:
        3px 3px 6px var(--shadow-dark),
        -3px -3px 6px var(--shadow-light);
      transition: all 0.15s;
    }
    .send-btn:active {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .send-btn:disabled { opacity: 0.4; }

    /* Login */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100dvh;
      gap: 12px;
      padding: 20px;
    }
    .login-screen h1 {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.3px;
      margin-bottom: 12px;
    }
    .login-screen .login-card {
      padding: 24px;
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .login-screen input {
      width: 100%;
      padding: 10px 14px;
      color: var(--text);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      background: var(--bg);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
      outline: none;
    }
    .login-screen input:focus {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light),
        0 0 0 2px rgba(62,207,142,0.3);
    }
    .login-screen input::placeholder { color: var(--text-dim); }
    .login-screen .login-btn {
      padding: 10px;
      background: var(--surface);
      color: var(--accent);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
      box-shadow:
        3px 3px 6px var(--shadow-dark),
        -3px -3px 6px var(--shadow-light);
      transition: all 0.15s;
    }
    .login-screen .login-btn:active {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .login-screen .toggle-link {
      font-size: 12px;
      color: var(--text-dim);
      cursor: pointer;
      text-align: center;
    }
    .login-screen .toggle-link:hover { color: var(--accent); }
    .login-screen .error-msg { color: var(--red); font-size: 12px; text-align: center; }
  </style>
</head>
<body>

  <!-- Login screen -->
  <div id="loginScreen" class="login-screen">
    <a href="/" style="color:inherit;text-decoration:none;"><h1>Claude Remote</h1></a>
    <div class="login-card neu">
      <input type="email" id="emailInput" placeholder="Email" autocomplete="email">
      <input type="password" id="passwordInput" data-i18n-placeholder="password">
      <button class="login-btn" onclick="doLogin()" data-i18n="signIn"></button>
      <p class="toggle-link" onclick="toggleRegister()" id="toggleAuthMode" data-i18n="noAccount"></p>
      <div id="loginError" class="error-msg"></div>
    </div>
  </div>

  <!-- Chat screen -->
  <div id="chatScreen" style="display:none; height:100dvh; flex-direction:column;">
    <div class="header">
      <div style="display:flex;align-items:center;gap:10px;">
        <a href="/"><h1>Claude Remote</h1></a>
        <div class="status-badge">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText" data-i18n="connecting"></span>
          <span id="daemonInfo" class="daemon-info"></span>
        </div>
        <div class="status-badge" id="encryptionBadge" style="display:none;gap:4px;font-size:10px;color:var(--green);">
          <span>&#128274;</span><span>E2E</span>
        </div>
      </div>
      <button class="hamburger" onclick="toggleMenu()">&#9776;</button>
      <div class="header-actions-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
      <div class="header-actions" id="headerActions">
        <div class="tts-switcher" style="position:relative;display:inline-block;">
          <button class="btn" onclick="toggleTTSMenu(event)" id="ttsBtn" style="font-size:15px;padding:4px 8px;">&#128266;</button>
          <div class="lang-dropdown" id="ttsDropdown">
            <a href="#" onclick="pickTTS('openai',event)" id="ttsOptOpenai">OpenAI</a>
            <a href="#" onclick="pickTTS('elevenlabs',event)" id="ttsOptElevenlabs">ElevenLabs</a>
          </div>
        </div>
        <div class="lang-switcher" style="position:relative;display:inline-block;">
          <button class="btn" onclick="toggleLangMenu(event)" id="langGlobe" style="font-size:15px;padding:4px 8px;">&#127760;</button>
          <div class="lang-dropdown" id="langDropdown">
            <a href="#" onclick="pickLang('en',event)" id="langOptEn">English</a>
            <a href="#" onclick="pickLang('ru',event)" id="langOptRu">–†—É—Å—Å–∫–∏–π</a>
            <a href="#" onclick="pickLang('es',event)" id="langOptEs">Espa√±ol</a>
            <a href="#" onclick="pickLang('pt',event)" id="langOptPt">Portugu√™s</a>
            <a href="#" onclick="pickLang('fr',event)" id="langOptFr">Fran√ßais</a>
            <a href="#" onclick="pickLang('de',event)" id="langOptDe">Deutsch</a>
            <a href="#" onclick="pickLang('ja',event)" id="langOptJa">Êó•Êú¨Ë™û</a>
            <a href="#" onclick="pickLang('ko',event)" id="langOptKo">ÌïúÍµ≠Ïñ¥</a>
            <a href="#" onclick="pickLang('zh',event)" id="langOptZh">‰∏≠Êñá</a>
            <a href="#" onclick="pickLang('hi',event)" id="langOptHi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</a>
            <a href="#" onclick="pickLang('tr',event)" id="langOptTr">T√ºrk√ße</a>
            <a href="#" onclick="pickLang('uk',event)" id="langOptUk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</a>
          </div>
        </div>
        <button class="btn btn-accent" onclick="newChat()" data-i18n="clearChat"></button>
        <button class="btn" onclick="doLogout()" data-i18n="logout"></button>
      </div>
    </div>

    <div class="messages" id="messagesContainer"></div>

    <div class="input-area">
      <textarea id="messageInput" rows="1" data-i18n-placeholder="messagePlaceholder"
        oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">&#8593;</button>
    </div>
  </div>

  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>

  <!-- Firebase SDKs (compat for RTDB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    // === I18N ===
    const i18n = {
      en: {
        password: 'Password',
        signIn: 'Sign In',
        signUp: 'Sign Up',
        noAccount: "Don't have an account? Register",
        haveAccount: 'Already have an account? Sign In',
        connecting: 'connecting...',
        connected: 'connected',
        disconnected: 'disconnected',
        clearChat: 'Clear Chat',
        logout: 'Logout',
        messagePlaceholder: 'Message for Claude Code...',
        busy: 'busy',
        offline: 'offline',
        daemonNotRunning: 'daemon not running',
        lastSeen: 'last seen',
        processing: 'processing',
        queue: 'queue',
        up: 'up',
      },
      ru: {
        password: '–ü–∞—Ä–æ–ª—å',
        signIn: '–í–æ–π—Ç–∏',
        signUp: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
        noAccount: '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',
        haveAccount: '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏',
        connecting: '–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...',
        connected: '–ø–æ–¥–∫–ª—é—á—ë–Ω',
        disconnected: '–æ—Ç–∫–ª—é—á—ë–Ω',
        clearChat: '–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç',
        logout: '–í—ã—Ö–æ–¥',
        messagePlaceholder: '–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Claude Code...',
        busy: '–∑–∞–Ω—è—Ç',
        offline: '–Ω–µ –≤ —Å–µ—Ç–∏',
        daemonNotRunning: '–¥–µ–º–æ–Ω –Ω–µ –∑–∞–ø—É—â–µ–Ω',
        lastSeen: '–±—ã–ª',
        processing: '–æ–±—Ä–∞–±–æ—Ç–∫–∞',
        queue: '–æ—á–µ—Ä–µ–¥—å',
        up: '—Ä–∞–±–æ—Ç–∞–µ—Ç',
      },
      es: {
        password: 'Contrase√±a',
        signIn: 'Iniciar sesi√≥n',
        signUp: 'Registrarse',
        noAccount: '¬øNo tienes cuenta? Reg√≠strate',
        haveAccount: '¬øYa tienes cuenta? Inicia sesi√≥n',
        connecting: 'conectando...',
        connected: 'conectado',
        disconnected: 'desconectado',
        clearChat: 'Limpiar chat',
        logout: 'Salir',
        messagePlaceholder: 'Mensaje para Claude Code...',
        busy: 'ocupado',
        offline: 'sin conexi√≥n',
        daemonNotRunning: 'daemon no est√° corriendo',
        lastSeen: 'visto',
        processing: 'procesando',
        queue: 'cola',
        up: 'activo',
      },
      pt: {
        password: 'Senha',
        signIn: 'Entrar',
        signUp: 'Cadastrar',
        noAccount: 'N√£o tem conta? Cadastre-se',
        haveAccount: 'J√° tem conta? Entrar',
        connecting: 'conectando...',
        connected: 'conectado',
        disconnected: 'desconectado',
        clearChat: 'Limpar chat',
        logout: 'Sair',
        messagePlaceholder: 'Mensagem para Claude Code...',
        busy: 'ocupado',
        offline: 'offline',
        daemonNotRunning: 'daemon n√£o est√° rodando',
        lastSeen: 'visto',
        processing: 'processando',
        queue: 'fila',
        up: 'ativo',
      },
      fr: {
        password: 'Mot de passe',
        signIn: 'Se connecter',
        signUp: "S'inscrire",
        noAccount: "Pas de compte ? S'inscrire",
        haveAccount: 'D√©j√† un compte ? Se connecter',
        connecting: 'connexion...',
        connected: 'connect√©',
        disconnected: 'd√©connect√©',
        clearChat: 'Effacer le chat',
        logout: 'D√©connexion',
        messagePlaceholder: 'Message pour Claude Code...',
        busy: 'occup√©',
        offline: 'hors ligne',
        daemonNotRunning: 'daemon non lanc√©',
        lastSeen: 'vu',
        processing: 'traitement',
        queue: 'file',
        up: 'actif',
      },
      de: {
        password: 'Passwort',
        signIn: 'Anmelden',
        signUp: 'Registrieren',
        noAccount: 'Kein Konto? Registrieren',
        haveAccount: 'Bereits ein Konto? Anmelden',
        connecting: 'verbinde...',
        connected: 'verbunden',
        disconnected: 'getrennt',
        clearChat: 'Chat l√∂schen',
        logout: 'Abmelden',
        messagePlaceholder: 'Nachricht an Claude Code...',
        busy: 'besch√§ftigt',
        offline: 'offline',
        daemonNotRunning: 'Daemon l√§uft nicht',
        lastSeen: 'zuletzt',
        processing: 'verarbeite',
        queue: 'Warteschlange',
        up: 'aktiv',
      },
      ja: {
        password: '„Éë„Çπ„ÉØ„Éº„Éâ',
        signIn: '„É≠„Ç∞„Ç§„É≥',
        signUp: 'Êñ∞Ë¶èÁôªÈå≤',
        noAccount: '„Ç¢„Ç´„Ç¶„É≥„Éà„Åå„Å™„ÅÑÔºüÁôªÈå≤„Åô„Çã',
        haveAccount: '„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°Ôºü„É≠„Ç∞„Ç§„É≥',
        connecting: 'Êé•Á∂ö‰∏≠...',
        connected: 'Êé•Á∂öÊ∏à„Åø',
        disconnected: 'ÂàáÊñ≠',
        clearChat: '„ÉÅ„É£„ÉÉ„Éà„Çí„ÇØ„É™„Ç¢',
        logout: '„É≠„Ç∞„Ç¢„Ç¶„Éà',
        messagePlaceholder: 'Claude Code„Å∏„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏...',
        busy: 'Âá¶ÁêÜ‰∏≠',
        offline: '„Ç™„Éï„É©„Ç§„É≥',
        daemonNotRunning: '„Éá„Éº„É¢„É≥Êú™Ëµ∑Âãï',
        lastSeen: 'ÊúÄÁµÇÁ¢∫Ë™ç',
        processing: 'Âá¶ÁêÜ‰∏≠',
        queue: '„Ç≠„É•„Éº',
        up: 'Á®ºÂÉç‰∏≠',
      },
      ko: {
        password: 'ÎπÑÎ∞ÄÎ≤àÌò∏',
        signIn: 'Î°úÍ∑∏Ïù∏',
        signUp: 'ÌöåÏõêÍ∞ÄÏûÖ',
        noAccount: 'Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî? Í∞ÄÏûÖÌïòÍ∏∞',
        haveAccount: 'Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî? Î°úÍ∑∏Ïù∏',
        connecting: 'Ïó∞Í≤∞ Ï§ë...',
        connected: 'Ïó∞Í≤∞Îê®',
        disconnected: 'Ïó∞Í≤∞ ÎÅäÍπÄ',
        clearChat: 'Ï±ÑÌåÖ ÏßÄÏö∞Í∏∞',
        logout: 'Î°úÍ∑∏ÏïÑÏõÉ',
        messagePlaceholder: 'Claude CodeÏóê Î©îÏãúÏßÄ...',
        busy: 'Ï≤òÎ¶¨ Ï§ë',
        offline: 'Ïò§ÌîÑÎùºÏù∏',
        daemonNotRunning: 'Îç∞Î™¨ ÎØ∏Ïã§Ìñâ',
        lastSeen: 'ÎßàÏßÄÎßâ ÌôïÏù∏',
        processing: 'Ï≤òÎ¶¨ Ï§ë',
        queue: 'ÎåÄÍ∏∞Ïó¥',
        up: 'Ïã§Ìñâ Ï§ë',
      },
      zh: {
        password: 'ÂØÜÁ†Å',
        signIn: 'ÁôªÂΩï',
        signUp: 'Ê≥®ÂÜå',
        noAccount: 'Ê≤°ÊúâË¥¶Âè∑ÔºüÊ≥®ÂÜå',
        haveAccount: 'Â∑≤ÊúâË¥¶Âè∑ÔºüÁôªÂΩï',
        connecting: 'ËøûÊé•‰∏≠...',
        connected: 'Â∑≤ËøûÊé•',
        disconnected: 'Â∑≤Êñ≠ÂºÄ',
        clearChat: 'Ê∏ÖÈô§ËÅäÂ§©',
        logout: 'ÈÄÄÂá∫',
        messagePlaceholder: 'ÂèëÈÄÅÊ∂àÊÅØÁªô Claude Code...',
        busy: 'ÂøôÁ¢å',
        offline: 'Á¶ªÁ∫ø',
        daemonNotRunning: 'ÂÆàÊä§ËøõÁ®ãÊú™ËøêË°å',
        lastSeen: 'ÊúÄÂêéÂú®Á∫ø',
        processing: 'Â§ÑÁêÜ‰∏≠',
        queue: 'ÈòüÂàó',
        up: 'ËøêË°å‰∏≠',
      },
      hi: {
        password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
        signIn: '‡§∏‡§æ‡§á‡§® ‡§á‡§®',
        signUp: '‡§∏‡§æ‡§á‡§® ‡§Ö‡§™',
        noAccount: '‡§ñ‡§æ‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à? ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç',
        haveAccount: '‡§ñ‡§æ‡§§‡§æ ‡§π‡•à? ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç',
        connecting: '‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
        connected: '‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°',
        disconnected: '‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°',
        clearChat: '‡§ö‡•à‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç',
        logout: '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
        messagePlaceholder: 'Claude Code ‡§ï‡•ã ‡§∏‡§Ç‡§¶‡•á‡§∂...',
        busy: '‡§µ‡•ç‡§Ø‡§∏‡•ç‡§§',
        offline: '‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§®',
        daemonNotRunning: '‡§°‡•á‡§Æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§≤ ‡§∞‡§π‡§æ',
        lastSeen: '‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡§æ‡§∞',
        processing: '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó',
        queue: '‡§ï‡§§‡§æ‡§∞',
        up: '‡§ö‡§æ‡§≤‡•Ç',
      },
      tr: {
        password: '≈ûifre',
        signIn: 'Giri≈ü Yap',
        signUp: 'Kayƒ±t Ol',
        noAccount: 'Hesabƒ±n yok mu? Kayƒ±t ol',
        haveAccount: 'Hesabƒ±n var mƒ±? Giri≈ü yap',
        connecting: 'baƒülanƒ±yor...',
        connected: 'baƒülandƒ±',
        disconnected: 'baƒülantƒ± kesildi',
        clearChat: 'Sohbeti temizle',
        logout: '√áƒ±kƒ±≈ü',
        messagePlaceholder: 'Claude Code i√ßin mesaj...',
        busy: 'me≈ügul',
        offline: '√ßevrimdƒ±≈üƒ±',
        daemonNotRunning: 'daemon √ßalƒ±≈ümƒ±yor',
        lastSeen: 'son g√∂r√ºlme',
        processing: 'i≈üleniyor',
        queue: 'kuyruk',
        up: 'aktif',
      },
      uk: {
        password: '–ü–∞—Ä–æ–ª—å',
        signIn: '–£–≤—ñ–π—Ç–∏',
        signUp: '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è',
        noAccount: '–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è',
        haveAccount: '–Ñ –∞–∫–∞—É–Ω—Ç? –£–≤—ñ–π—Ç–∏',
        connecting: "–∑'—î–¥–Ω–∞–Ω–Ω—è...",
        connected: "–∑'—î–¥–Ω–∞–Ω–æ",
        disconnected: "–≤—ñ–¥'—î–¥–Ω–∞–Ω–æ",
        clearChat: '–û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç',
        logout: '–í–∏—Ö—ñ–¥',
        messagePlaceholder: '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è Claude Code...',
        busy: '–∑–∞–π–Ω—è—Ç–∏–π',
        offline: '–æ—Ñ–ª–∞–π–Ω',
        daemonNotRunning: '–¥–µ–º–æ–Ω –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ',
        lastSeen: '–æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–∞–∑',
        processing: '–æ–±—Ä–æ–±–∫–∞',
        queue: '—á–µ—Ä–≥–∞',
        up: '–ø—Ä–∞—Ü—é—î',
      }
    };

    let currentLang = 'en';

    const SUPPORTED_LANGS = ['en','ru','es','pt','fr','de','ja','ko','zh','hi','tr','uk'];

    function detectLang() {
      const stored = localStorage.getItem('lang_chosen');
      if (SUPPORTED_LANGS.includes(stored)) return stored;
      const nav = (navigator.language || '').toLowerCase();
      const prefix = nav.split('-')[0];
      if (SUPPORTED_LANGS.includes(prefix)) return prefix;
      return 'en';
    }

    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem('lang_chosen', lang);
      if (typeof updateLangHighlight === 'function') updateLangHighlight();
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = i18n[lang][el.dataset.i18n] || '';
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        el.placeholder = i18n[lang][el.dataset.i18nPlaceholder] || '';
      });
    }

    function toggleMenu() {
      document.getElementById('headerActions').classList.toggle('open');
      document.getElementById('menuOverlay').classList.toggle('open');
    }

    function toggleLangMenu(e) {
      e.stopPropagation();
      document.getElementById('ttsDropdown').classList.remove('open');
      document.getElementById('langDropdown').classList.toggle('open');
    }
    function pickLang(lang, e) {
      e.preventDefault();
      setLang(lang);
      document.getElementById('langDropdown').classList.remove('open');
      updateLangHighlight();
    }
    function updateLangHighlight() {
      SUPPORTED_LANGS.forEach(function(lang) {
        var el = document.getElementById('langOpt' + lang.charAt(0).toUpperCase() + lang.slice(1));
        if (el) el.className = currentLang === lang ? 'active' : '';
      });
    }

    function toggleTTSMenu(e) {
      e.stopPropagation();
      document.getElementById('langDropdown').classList.remove('open');
      document.getElementById('ttsDropdown').classList.toggle('open');
    }
    function pickTTS(provider, e) {
      e.preventDefault();
      changeTTSProvider(provider);
      document.getElementById('ttsDropdown').classList.remove('open');
      updateTTSHighlight();
    }
    function updateTTSHighlight() {
      ['openai', 'elevenlabs'].forEach(function(p) {
        var el = document.getElementById('ttsOpt' + p.charAt(0).toUpperCase() + p.slice(1));
        if (el) el.className = ttsProvider === p ? 'active' : '';
      });
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.lang-switcher')) {
        document.getElementById('langDropdown').classList.remove('open');
      }
      if (!e.target.closest('.tts-switcher')) {
        document.getElementById('ttsDropdown').classList.remove('open');
      }
    });

    currentLang = detectLang();

    let isRegisterMode = false;
    function toggleRegister() {
      isRegisterMode = !isRegisterMode;
      const btn = document.querySelector('[data-i18n="signIn"], [data-i18n="signUp"]');
      const toggle = document.getElementById('toggleAuthMode');
      if (isRegisterMode) {
        btn.dataset.i18n = 'signUp';
        toggle.dataset.i18n = 'haveAccount';
      } else {
        btn.dataset.i18n = 'signIn';
        toggle.dataset.i18n = 'noAccount';
      }
      setLang(currentLang);
    }

    // === MARKDOWN SETUP ===
    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true
    });

    function renderMarkdown(div, text, role) {
      if (role === 'assistant' && text) {
        const btn = div.querySelector('.tts-btn');
        div.innerHTML = '';
        const ttsBtn = btn || document.createElement('button');
        if (!btn) {
          ttsBtn.className = 'tts-btn';
          ttsBtn.innerHTML = 'üîä';
          ttsBtn.title = 'Text to Speech';
          ttsBtn.onclick = () => toggleTTS(ttsBtn, text);
        }
        div.appendChild(ttsBtn);
        const content = document.createElement('div');
        content.innerHTML = marked.parse(text);
        div.appendChild(content);
      } else {
        div.textContent = text;
      }
    }

    // === TTS ===
    // Providers: openai (gpt-4o-mini-tts), elevenlabs (eleven_multilingual_v2), browser (fallback)
    const TTS_PROVIDERS = {
      openai: { label: 'OpenAI', provider: 'openai', model: 'gpt-4o-mini-tts', voice: 'nova' },
      elevenlabs: { label: 'ElevenLabs', provider: 'elevenlabs', model: 'eleven_multilingual_v2' }
    };

    let ttsProvider = localStorage.getItem('tts_provider') || 'openai';
    let currentTTSBtn = null;
    let currentAudio = null;

    function cleanTextForTTS(text) {
      return text.replace(/```[\s\S]*?```/g, ' code block ')
                 .replace(/[#*_`~\[\]()>|]/g, '')
                 .replace(/\n+/g, '. ')
                 .substring(0, 3000);
    }

    function stopCurrentTTS() {
      if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
      currentAudio = null;
      speechSynthesis.cancel();
      if (currentTTSBtn) currentTTSBtn.classList.remove('speaking');
    }

    async function toggleTTS(btn, text) {
      if (currentTTSBtn === btn && (currentAudio && !currentAudio.paused || speechSynthesis.speaking)) {
        stopCurrentTTS();
        currentTTSBtn = null;
        return;
      }
      stopCurrentTTS();

      const clean = cleanTextForTTS(text);
      btn.classList.add('speaking', 'loading');
      currentTTSBtn = btn;

      const cfg = TTS_PROVIDERS[ttsProvider];
      if (!cfg) {
        // fallback to browser
        btn.classList.remove('loading');
        fallbackBrowserTTS(clean, btn);
        return;
      }

      try {
        const opts = { provider: cfg.provider, model: cfg.model };
        if (cfg.voice) opts.voice = cfg.voice;
        const audio = await puter.ai.txt2speech(clean, opts);
        btn.classList.remove('loading');
        currentAudio = audio;
        currentAudio.onended = () => {
          btn.classList.remove('speaking');
          currentTTSBtn = null;
        };
        currentAudio.onerror = (e) => {
          console.warn('TTS playback failed:', e);
          fallbackBrowserTTS(clean, btn);
        };
        await currentAudio.play();
      } catch (err) {
        console.warn('Puter TTS error:', err, '‚Äî falling back to browser TTS');
        btn.classList.remove('loading');
        fallbackBrowserTTS(clean, btn);
      }
    }

    function changeTTSProvider(val) {
      ttsProvider = val;
      localStorage.setItem('tts_provider', val);
      stopCurrentTTS();
    }

    function fallbackBrowserTTS(clean, btn) {
      const utter = new SpeechSynthesisUtterance(clean);
      const langMap = {en:'en-US',ru:'ru-RU',es:'es-ES',pt:'pt-BR',fr:'fr-FR',de:'de-DE',ja:'ja-JP',ko:'ko-KR',zh:'zh-CN',hi:'hi-IN',tr:'tr-TR',uk:'uk-UA'};
      utter.lang = langMap[currentLang] || 'en-US';
      btn.classList.add('speaking');
      currentTTSBtn = btn;
      utter.onend = () => { btn.classList.remove('speaking'); currentTTSBtn = null; };
      utter.onerror = () => { btn.classList.remove('speaking'); currentTTSBtn = null; };
      speechSynthesis.speak(utter);
    }

    // === FIREBASE CONFIG (chilin1) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCxV6rBIk88Ur7qDMknibWZYs2D5zmVoFI",
      authDomain: "chilin1.firebaseapp.com",
      databaseURL: "https://chilin1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "chilin1",
      storageBucket: "chilin1.appspot.com",
      messagingSenderId: "904851088567",
      appId: "1:904851088567:web:360cc8fd71db535c73d932"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const rtdb = firebase.database();

    let currentUser = null;
    let currentSessionId = null;
    let messagesRef = null;

    // === E2E ENCRYPTION (ECDH P-256 + AES-256-GCM) ===
    let cryptoKeyPair = null;   // browser ECDH key pair
    let sharedAESKey = null;    // derived AES-GCM key for current session
    let encryptionReady = false;

    async function generateKeyPair() {
      cryptoKeyPair = await crypto.subtle.generateKey(
        { name: 'ECDH', namedCurve: 'P-256' },
        false, ['deriveKey']
      );
      // Export public key as base64
      const raw = await crypto.subtle.exportKey('raw', cryptoKeyPair.publicKey);
      return btoa(String.fromCharCode(...new Uint8Array(raw)));
    }

    async function deriveAESKey(daemonPubKeyB64) {
      const raw = Uint8Array.from(atob(daemonPubKeyB64), c => c.charCodeAt(0));
      const daemonPub = await crypto.subtle.importKey(
        'raw', raw, { name: 'ECDH', namedCurve: 'P-256' }, false, []
      );
      sharedAESKey = await crypto.subtle.deriveKey(
        { name: 'ECDH', public: daemonPub },
        cryptoKeyPair.privateKey,
        { name: 'AES-GCM', length: 256 },
        false, ['encrypt', 'decrypt']
      );
      encryptionReady = true;
      updateEncryptionStatus(true);
    }

    async function encryptText(plaintext) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encoded = new TextEncoder().encode(plaintext);
      const ciphertext = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv }, sharedAESKey, encoded
      );
      return {
        text: btoa(String.fromCharCode(...new Uint8Array(ciphertext))),
        iv: btoa(String.fromCharCode(...iv))
      };
    }

    async function decryptText(ciphertextB64, ivB64) {
      try {
        const ciphertext = Uint8Array.from(atob(ciphertextB64), c => c.charCodeAt(0));
        const iv = Uint8Array.from(atob(ivB64), c => c.charCodeAt(0));
        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv }, sharedAESKey, ciphertext
        );
        return new TextDecoder().decode(decrypted);
      } catch (e) {
        console.error('Decryption failed:', e);
        return null; // null = can't decrypt (wrong key / other session)
      }
    }

    function updateEncryptionStatus(ready) {
      const badge = document.getElementById('encryptionBadge');
      if (badge) {
        badge.style.display = ready ? 'inline-flex' : 'none';
      }
    }

    async function setupEncryption() {
      encryptionReady = false;
      sharedAESKey = null;
      updateEncryptionStatus(false);

      const pubKeyB64 = await generateKeyPair();
      const sessionKeysRef = rtdb.ref(`sessions/${currentUser.uid}/${currentSessionId}/keys`);

      // Write browser key and delete stale daemon key atomically
      // This forces the daemon to re-derive with our new keypair
      await sessionKeysRef.update({
        browser: pubKeyB64,
        daemon: null   // delete old daemon key
      });

      // Listen for daemon to post its new public key
      const daemonKeyRef = sessionKeysRef.child('daemon');
      daemonKeyRef.on('value', async snap => {
        const daemonKey = snap.val();
        if (daemonKey && !encryptionReady) {
          await deriveAESKey(daemonKey);
          daemonKeyRef.off();
        }
      });
    }

    // === AUTH ===
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('loginScreen').style.display = 'none';
        const chat = document.getElementById('chatScreen');
        chat.style.display = 'flex';
        loadOrCreateSession();
        monitorDaemon();
      } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('chatScreen').style.display = 'none';
      }
    });

    function doLogout() {
      auth.signOut();
    }

    async function doLogin() {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      try {
        if (isRegisterMode) {
          await auth.createUserWithEmailAndPassword(email, password);
          // Increment public user counter
          rtdb.ref('stats/userCount').transaction(c => (c || 0) + 1);
        } else {
          await auth.signInWithEmailAndPassword(email, password);
        }
      } catch (e) {
        document.getElementById('loginError').textContent = e.message;
      }
    }

    // === SESSION MANAGEMENT ===
    function loadOrCreateSession() {
      const sessionsRef = rtdb.ref(`sessions/${currentUser.uid}`);
      sessionsRef.limitToLast(5).once('value', async snap => {
        if (snap.exists()) {
          const keys = Object.keys(snap.val()).filter(k => k !== '_heartbeat');
          if (keys.length > 0) {
            currentSessionId = keys[keys.length - 1];
          } else {
            createNewSession();
          }
        } else {
          createNewSession();
        }
        await setupEncryption();
        listenToMessages();
      });
    }

    function createNewSession() {
      const sessionsRef = rtdb.ref(`sessions/${currentUser.uid}`);
      const newRef = sessionsRef.push();
      currentSessionId = newRef.key;
      newRef.set({ createdAt: firebase.database.ServerValue.TIMESTAMP });
    }

    async function newChat() {
      if (messagesRef) messagesRef.off();
      document.getElementById('messagesContainer').innerHTML = '';
      createNewSession();
      await setupEncryption();
      listenToMessages();
    }

    // === MESSAGES LISTENER ===
    function listenToMessages() {
      if (messagesRef) messagesRef.off();

      messagesRef = rtdb.ref(`sessions/${currentUser.uid}/${currentSessionId}/messages`);
      const container = document.getElementById('messagesContainer');
      const rendered = new Set();

      messagesRef.orderByChild('timestamp').on('child_added', async snap => {
        const msg = snap.val();
        const id = snap.key;
        if (rendered.has(id)) return;
        rendered.add(id);

        let text = msg.text || '';
        let undecryptable = false;
        if (msg.encrypted && msg.iv) {
          if (encryptionReady) {
            const decrypted = await decryptText(text, msg.iv);
            if (decrypted !== null) {
              text = decrypted;
            } else {
              undecryptable = true;
            }
          } else {
            undecryptable = true;
          }
        }

        const div = document.createElement('div');
        div.className = `message ${msg.role}`;
        div.id = `msg-${id}`;
        if (undecryptable) {
          div.classList.add('encrypted-blur');
        }
        if (msg.status === 'processing') div.classList.add('processing');
        if (msg.status === 'error') div.classList.add('error');
        renderMarkdown(div, undecryptable ? 'Encrypted message from another session' : text, msg.role);
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      });

      messagesRef.on('child_changed', async snap => {
        const msg = snap.val();
        const div = document.getElementById(`msg-${snap.key}`);
        if (div) {
          let text = msg.text || '';
          let undecryptable = false;
          if (msg.encrypted && msg.iv) {
            if (encryptionReady) {
              const decrypted = await decryptText(text, msg.iv);
              if (decrypted !== null) {
                text = decrypted;
              } else {
                undecryptable = true;
              }
            } else {
              undecryptable = true;
            }
          }
          div.classList.toggle('encrypted-blur', undecryptable);
          renderMarkdown(div, undecryptable ? 'Encrypted message from another session' : text, msg.role);
          div.classList.toggle('processing', msg.status === 'processing');
          div.classList.toggle('error', msg.status === 'error');
          container.scrollTop = container.scrollHeight;
        }
      });
    }

    // === SEND MESSAGE ===
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      input.value = '';
      autoResize(input);

      // If encryption not ready (e.g. old session with undecryptable messages),
      // auto-create a new session without clearing chat UI
      if (!encryptionReady) {
        if (messagesRef) messagesRef.off();
        createNewSession();
        await setupEncryption();
        listenToMessages();
        // Restore normal placeholder
        const t = i18n[currentLang] || i18n.en;
        input.placeholder = t.messagePlaceholder;
        // Wait briefly for encryption handshake
        let waited = 0;
        while (!encryptionReady && waited < 5000) {
          await new Promise(r => setTimeout(r, 200));
          waited += 200;
        }
      }

      const msgRef = rtdb.ref(`sessions/${currentUser.uid}/${currentSessionId}/messages`);

      if (encryptionReady) {
        const { text: encrypted, iv } = await encryptText(text);
        await msgRef.push({
          role: 'user',
          text: encrypted,
          iv: iv,
          encrypted: true,
          status: 'pending',
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      } else {
        await msgRef.push({
          role: 'user',
          text: text,
          status: 'pending',
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }

    // === UI HELPERS ===
    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    function updateStatus(status) {
      const dot = document.getElementById('statusDot');
      const txt = document.getElementById('statusText');
      const t = i18n[currentLang];
      const labels = { online: t.connected, busy: t.busy, offline: t.offline, disconnected: t.disconnected };
      txt.textContent = labels[status] || t.connecting;
      dot.className = `status-dot ${status}`;
    }

    // === DAEMON HEALTH MONITOR ===
    function monitorDaemon() {
      const ref = rtdb.ref(`sessions/${currentUser.uid}/_heartbeat`);
      ref.on('value', snap => {
        const d = snap.val();
        const infoEl = document.getElementById('daemonInfo');
        const t = i18n[currentLang];
        if (!d || !d.lastHeartbeat) {
          updateStatus('offline');
          infoEl.textContent = t.daemonNotRunning;
          return;
        }
        const ago = Math.floor((Date.now() - d.lastHeartbeat) / 1000);
        if (ago > 90) {
          updateStatus('offline');
          infoEl.textContent = `${t.lastSeen} ${formatAgo(ago)}`;
        } else if (d.status === 'stopped') {
          updateStatus('offline');
          infoEl.textContent = t.daemonNotRunning;
        } else {
          updateStatus(d.status === 'busy' ? 'busy' : 'online');
          const parts = [];
          if (d.status === 'busy') parts.push(t.processing);
          if (d.hostname) parts.push(d.hostname);
          infoEl.textContent = parts.join(' ¬∑ ');
        }
      });
    }

    function formatAgo(sec) {
      if (sec < 60) return `${sec}s`;
      if (sec < 3600) return `${Math.floor(sec/60)}m`;
      return `${Math.floor(sec/3600)}h`;
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey && document.activeElement === document.getElementById('messageInput')) {
        e.preventDefault();
        sendMessage();
      }
    });

    setLang(currentLang);
    updateLangHighlight();

    // Init TTS provider highlight
    updateTTSHighlight();

  </script>
</body>
</html>
