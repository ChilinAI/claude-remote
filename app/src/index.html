<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Remote</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    /* Dark theme (default) */
    :root {
      --bg: #2d2d2d;
      --surface: #333333;
      --text: #f0f0f0;
      --text-dim: #999;
      --accent: #3ecf8e;
      --accent-hover: #4ee0a0;
      --green: #3ecf8e;
      --yellow: #f5c542;
      --red: #ef5350;
      --radius: 12px;
      --shadow-dark: #252525;
      --shadow-light: #3a3a3a;
    }

    /* Light theme */
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #e0e0e0;
        --surface: #e8e8e8;
        --text: #1a1a1a;
        --text-dim: #666;
        --accent: #2ea86e;
        --accent-hover: #3ecf8e;
        --green: #2ea86e;
        --yellow: #d4a830;
        --red: #d43f3f;
        --shadow-dark: #c8c8c8;
        --shadow-light: #f5f5f5;
      }
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px 16px 8px 16px;
      font-size: 13px;
      -webkit-font-smoothing: antialiased;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Neumorphic base */
    .neu {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow:
        4px 4px 8px var(--shadow-dark),
        -4px -4px 8px var(--shadow-light);
    }
    .neu-inset {
      background: var(--bg);
      border-radius: 8px;
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding: 0;
    }
    .header h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }
    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-dim);
    }
    .status-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--red);
    }
    .status-dot.connected { background: var(--green); box-shadow: 0 0 8px rgba(62,207,142,0.5); }
    .status-dot.authenticated { background: var(--yellow); box-shadow: 0 0 8px rgba(245,197,66,0.4); }

    /* Sections */
    .section {
      padding: 14px;
      margin-bottom: 16px;
    }
    .section:last-child { margin-bottom: 0; }
    .section h2 {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      text-align: right;
    }

    /* Form elements */
    label {
      display: block;
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 4px;
      font-weight: 500;
    }
    input[type="text"], input[type="email"], input[type="password"] {
      width: 100%;
      padding: 5px 10px 7px 10px;
      color: var(--text-dim);
      border: none;
      border-radius: 8px;
      font-size: 10px;
      margin-bottom: 8px;
      font-family: 'SF Mono', Menlo, monospace;
      transition: box-shadow 0.2s;
      background: var(--bg);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    input:focus {
      outline: none;
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light),
        0 0 0 2px rgba(212,118,78,0.3);
    }

    /* Buttons */
    .btn {
      padding: 3px 10px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
      background: var(--surface);
      color: var(--text);
      box-shadow:
        3px 3px 6px var(--shadow-dark),
        -3px -3px 6px var(--shadow-light);
    }
    .btn:hover {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
      color: var(--text);
    }
    .btn:active {
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .btn-primary, .btn-secondary, .btn-green {
      background: var(--surface);
      color: var(--text-dim);
    }
    .btn-green:hover { color: var(--green); }
    .btn:disabled { opacity: 0.6; cursor: default; transform: none; }
    .btn-row { display: flex; gap: 8px; margin-top: 6px; justify-content: center; }

    /* Messages */
    .error { color: var(--red); font-size: 11px; margin-top: 4px; }
    .success { color: var(--green); font-size: 11px; margin-top: 4px; }
    .info { color: var(--text-dim); font-size: 12px; }
    .hidden { display: none !important; }
    #userSection:not(.hidden) { display: flex; flex-direction: column; }

    /* Top row */
    .top-row {
      display: grid;
      grid-template-columns: 190px 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .top-row .section { margin-bottom: 0; }

    /* Inline field + button */
    .inline { display: flex; gap: 6px; align-items: center; margin-bottom: 8px; }
    .inline input { margin-bottom: 0; flex: 1; }

    /* Log */
    .log {
      padding: 8px;
      border-radius: 8px;
      font-family: 'SF Mono', Menlo, monospace;
      font-size: 10px;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      color: var(--text-dim);
      line-height: 1.5;
      background: var(--bg);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
    .log::-webkit-scrollbar { width: 4px; }
    .log::-webkit-scrollbar-track { background: transparent; }
    .log::-webkit-scrollbar-thumb { background: var(--text-dim); opacity: 0.3; border-radius: 2px; }
    .log-entry.error { color: var(--red); }
    .log-entry.success { color: var(--green); }

    .btn-quit {
      background: var(--surface);
      border: none;
      color: var(--text-dim);
      font-size: 11px;
      cursor: pointer;
      padding: 3px 10px;
      border-radius: 8px;
      box-shadow:
        3px 3px 6px var(--shadow-dark),
        -3px -3px 6px var(--shadow-light);
    }
    .btn-quit:hover {
      color: var(--red);
      box-shadow:
        inset 2px 2px 4px var(--shadow-dark),
        inset -2px -2px 4px var(--shadow-light);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Claude Remote</h1>
    <span id="versionLabel" style="font-size:9px; color:var(--text-dim); opacity:0.4; font-family:'SF Mono',Menlo,monospace; margin-left:6px;"></span>
    <div style="display:flex; align-items:center; gap:8px; margin-left:auto;">
      <div class="status-badge">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
      </div>
      <button class="btn btn-green" id="startBtn" onclick="startDaemon()" style="padding:4px 10px; font-size:11px;">Start</button>
      <button class="btn btn-secondary" id="stopBtn" onclick="stopDaemon()" disabled style="padding:4px 10px; font-size:11px;">Stop</button>
      <div style="width:8px;"></div>
      <button class="btn-quit" onclick="quitApp()">Quit</button>
    </div>
  </div>

  <div class="top-row">
    <!-- Auth: Login -->
    <div class="section neu" id="authSection">
      <h2>Account</h2>
      <label>Email</label>
      <input type="email" id="email" placeholder="Email">
      <label>Password</label>
      <input type="password" id="password" placeholder="Password">
      <div class="btn-row">
        <button class="btn btn-primary" onclick="doLogin()" style="font-size:10px; position:relative; top:-2px;">Sign In</button>
        <button class="btn btn-secondary" onclick="doRegister()" style="font-size:10px; position:relative; top:-2px;">Register</button>
      </div>
      <div id="authMsg"></div>
    </div>

    <!-- Auth: Logged in -->
    <div class="section neu hidden" id="userSection">
      <h2>Account</h2>
      <div class="info" style="text-align:center; flex:1; display:flex; align-items:center; justify-content:center;">Signed in as <strong id="userEmail" style="margin-left:4px;"></strong></div>
      <div style="text-align:center; margin-top:auto;">
        <button class="btn btn-secondary" onclick="doLogout()" style="font-size:10px;">Sign Out</button>
      </div>
    </div>

    <!-- Settings -->
    <div class="section neu" id="settingsSection">
      <h2>Settings</h2>
      <label>Claude Code Path</label>
      <div class="inline">
        <input type="text" id="claudePath" placeholder="/Users/you/.local/bin/claude">
        <button class="btn btn-secondary" onclick="detectClaude()" style="position:relative; top:-3px; font-size:10px;">Detect</button>
      </div>
      <label>Working Directory</label>
      <div class="inline">
        <input type="text" id="workingDir" placeholder="/Users/you/projects">
        <button class="btn btn-primary" onclick="saveSettings()" style="position:relative; top:-2px; font-size:10px;">Save</button>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div class="section neu" style="flex:1; display:flex; flex-direction:column; min-height:0; overflow:hidden;">
    <h2>Log</h2>
    <div class="log" id="logContainer">
      <div class="log-entry">Ready.</div>
    </div>
  </div>

  <script>
    const { invoke } = window.__TAURI__.core;

    function log(msg, type = '') {
      const el = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      el.appendChild(entry);
      el.scrollTop = el.scrollHeight;
    }

    async function doLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const msg = document.getElementById('authMsg');
      try {
        await invoke('login', { email, password });
        msg.className = 'success';
        msg.textContent = 'Signed in!';
        showLoggedIn(email);
        log(`Authenticated as ${email}`, 'success');
        await startDaemon();
        log('Daemon auto-started', 'success');
      } catch (e) {
        msg.className = 'error';
        msg.textContent = e;
        log(`Auth error: ${e}`, 'error');
      }
    }

    async function doRegister() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const msg = document.getElementById('authMsg');
      try {
        await invoke('register', { email, password });
        msg.className = 'success';
        msg.textContent = 'Registered!';
        showLoggedIn(email);
        log(`Registered as ${email}`, 'success');
        await startDaemon();
        log('Daemon auto-started', 'success');
      } catch (e) {
        msg.className = 'error';
        msg.textContent = e;
      }
    }

    function showLoggedIn(email) {
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('userSection').classList.remove('hidden');
      document.getElementById('userEmail').textContent = email;
    }

    async function doLogout() {
      await invoke('logout');
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('userSection').classList.add('hidden');
      log('Signed out');
      stopDaemon();
    }

    async function detectClaude() {
      try {
        const path = await invoke('detect_claude');
        document.getElementById('claudePath').value = path;
        log(`Claude found: ${path}`, 'success');
        await saveSettings();
      } catch (e) {
        log(e, 'error');
      }
    }

    async function saveSettings() {
      const workingDir = document.getElementById('workingDir').value;
      const claudePath = document.getElementById('claudePath').value;
      const input = document.getElementById('workingDir');
      try {
        await invoke('save_config', { workingDir, claudePath });
        const orig = input.value;
        input.style.color = 'var(--green)';
        input.value = 'Saved!';
        log('Settings saved');
        setTimeout(() => {
          input.value = orig;
          input.style.color = '';
        }, 3000);
      } catch (e) {
        log(`Save error: ${e}`, 'error');
      }
    }

    async function startDaemon() {
      await invoke('start_daemon');
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      log('Daemon started', 'success');
      updateStatus();
    }

    async function stopDaemon() {
      await invoke('stop_daemon');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      log('Daemon stopped');
      updateStatus();
    }

    async function updateStatus() {
      try {
        const status = await invoke('get_status');
        document.getElementById('statusDot').className = `status-dot ${status}`;
        document.getElementById('statusText').textContent = status.charAt(0).toUpperCase() + status.slice(1);
      } catch (e) {}
    }

    setInterval(updateStatus, 5000);

    async function quitApp() {
      await invoke('quit_app');
    }

    async function init() {
      // Show version first
      try {
        const ver = await invoke('get_version');
        document.getElementById('versionLabel').textContent = `v${ver}`;
      } catch (e) {
        document.getElementById('versionLabel').textContent = 'v?';
      }

      try {
        const config = await invoke('get_config');
        if (config.claude_path) document.getElementById('claudePath').value = config.claude_path;
        if (config.working_dir) document.getElementById('workingDir').value = config.working_dir;
      } catch (e) {}

      // Try to restore saved session
      let sessionRestored = false;
      try {
        const session = await invoke('restore_session');
        showLoggedIn(session.email);
        log(`Session restored: ${session.email}`, 'success');
        sessionRestored = true;
      } catch (e) {
        // No saved session, show login form
      }

      detectClaude();
      await updateStatus();

      // Sync Start/Stop buttons with actual daemon state
      const status = await invoke('get_status');
      if (status === 'connected') {
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        log('Daemon already running (autostart)', 'success');
      } else if (sessionRestored) {
        // Auto-start daemon after successful session restore
        await startDaemon();
        log('Daemon auto-started', 'success');
      }

      // Updates are checked automatically in background every hour
      // and installed when daemon is stopped
      log('Updates: auto-check enabled (hourly)');
    }

    init();
  </script>
</body>
</html>
